importScripts("ExtPay.js"),importScripts("common.js");const extpay=ExtPay("unsubscriby-for-youtube");extpay.startBackground(),chrome.runtime.onMessage.addListener((async(t,e,o)=>{if("start"===t.message){if(console.log("background received start"),await pingActiveTabContentScript())return console.log("background received pong 1"),void sendMessageToActiveTab({message:"start"});const t="https://www.youtube.com/feed/channels";let e=await chrome.tabs.create({url:t});if(!await waitTabToComplete(e))return void console.log("error: try again");await pingTabContentScript(e.id)&&(console.log("background received pong 2"),chrome.tabs.sendMessage(e.id,{message:"start"}))}return"purchase"===t.message&&extpay.openPaymentPage(),"complete"===t.message&&chrome.notifications.create({type:"basic",iconUrl:"images/32x32.png",title:"Unsubscriby for Youtube",message:`Done! Total of ${t.count} subs unsubscribed!`}),"stopped"===t.message&&chrome.notifications.create({type:"basic",iconUrl:"images/32x32.png",title:"Unsubscriby for Youtube",message:"Stopped!"}),!0}));const sendMessageToActiveTab=async function(t){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return await chrome.tabs.sendMessage(e.id,t)},waitTabToComplete=async function(t){console.log(`created tab id: ${t.id}`);let e=0;for(;"complete"!=t.status&&(e++,console.log(`trying: ${e}`),console.log(`created tab status: ${t.status}`),await delay(500),!(e>=30));)t=await chrome.tabs.get(t.id);return console.log(`created tab status: ${t.status}`),!(e>=30)||(console.log("timeout"),!1)},pingTabContentScript=async function(t){return"pong"===await chrome.tabs.sendMessage(t,{message:"ping"})},pingActiveTabContentScript=async function(){let t="anything";try{t=await sendMessageToActiveTab({message:"ping"})}catch(t){return!1}return"pong"===t};chrome.runtime.onInstalled.addListener((async t=>{console.log("oninstalled");const e=await async function(){const t={button:"#subscribe-button-shape[invisible] > button",continuation:"#contents > ytd-continuation-item-renderer",confirmButton:"#confirm-button > yt-button-shape > button"};try{const e=await fetch("https://unsubscriby-for-yt-default-rtdb.firebaseio.com/csspath.json"),o=await e.json();if(console.log("css path data:"),console.log(o),!o)return t;return 0==Object.keys(o).length||o.error?t:o}catch(e){return console.log(e.name),console.log(e.message),t}}();storageSet(CONSTANTS.CSS_PATH_KEY,e)}));
